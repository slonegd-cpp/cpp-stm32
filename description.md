# Самый маленький размер прошивки для STM32, написанный на С++
Это первая часть тутроиала работы с микроконтроллерами STM32 на С++. Для большего интереса поставлена задача написания минимальной по размеру прошивки, **которая ничего не делает**. Я не люблю пользоваться IDE, которые предлагаются по-умолчанию для работы с этим семейством микроконтроллеров, потому что в них пользователь нажимает кнопки, но не понимает, что происходит на самом деле. Пример в этом туториале можно написать в любом текстовом редакторе. Всё что нужно, gcc компилятор, который может скачать каждый.

---
Предатсавлю сначала саму программу, потом объясню, что в ней значит каждая буква и как её собрать.
```cpp
#include <cstdint> // uint32_t

int main() {
    volatile int i(0);
    while (1) {
        i++;
    }
}

struct startup {
    uint32_t stack_pointer;
    uint32_t entry_point;
};
__attribute__((section(".startup"))) startup _ {
    .stack_pointer = 0x20050000,
    .entry_point = reinterpret_cast<uint32_t>(main)
};
```
После компиляции её размер:
```
   text    data     bss     dec     hex filename
     20       8       0      28      1c a.out
```
Любая программа на С++ должна иметь точку входа - функцию, обычно это функция main, которая возвращает int. Возвращаемое значение нужно для определения операционной системой успешность выполнения программы. Если программа выполнилась успешно, то возвращается 0. В микроконтроллерах программа не заканчивается, и там нет никакой операционной системы, поэтому там не нужно возвращаемое значение. Да и функция может называться как угодно, но я решил оставить как принято, чтобы никого не путать.

TODO: описать, что происходит в main.

Согласно programming manual на семейство микроконтроллеров, при запуске программы, первые 4 байта должны содержать указатель на стек, следующие 4 байта указатель на функцию, с которой начинается программа. На самом деле всё несколько сложнее, и далее должна быть целая таблица указателей на функции - обработчики прерываний, но задача сделать минимальную прошивку, поэтому в такие подробности пока не интересны.

Необходимо создать структуру с этими полями, размером 4 байта. Тип, занимающий ровно 4 байта `uint32_t` описан в стандартной библиотеке, для чего в первой строке подключен файл с этим описанием.

С помощью специального расширения компилятора gcc можно указать, что конкретный экземпляр этой структуры должна быть расположен компоновщиком в секторе памяти `.startup`.

Имя экземплятра структуры мне далее не нужно, поэтому я выбрал `_`.  Адрес указателя на стек зависит от конкретного микроконтроллера, его можно найти в **указать**. Название функции в C++ уже является адресом на неё, поэтому просто этот указатель нужно привести к 4-байтовому типу.

